<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>五子棋联机对战（实时同步版）</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-top: 20px;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .player-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }

        #status {
            font-size: 18px;
            font-weight: bold;
            margin: 15px 0;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            text-align: center;
        }

        #board {
            background-color: #dcb35c;
            display: grid;
            grid-template-columns: repeat(15, 30px);
            grid-template-rows: repeat(15, 30px);
            gap: 1px;
            margin: 20px auto;
            border: 2px solid #8b4513;
        }

        .cell {
            width: 30px;
            height: 30px;
            background-color: rgba(220, 179, 92, 0.7);
            position: relative;
            cursor: pointer;
        }

        .cell:hover {
            background-color: rgba(220, 179, 92, 0.9);
        }

        .cell::before, .cell::after {
            content: '';
            position: absolute;
            background-color: #000;
        }

        .cell::before {
            width: 100%;
            height: 1px;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
        }

        .cell::after {
            width: 1px;
            height: 100%;
            left: 50%;
            top: 0;
            transform: translateX(-50%);
        }

        .stone {
            position: absolute;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            z-index: 1;
            box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }

        .black {
            background-color: #000;
        }

        .white {
            background-color: #fff;
        }

        .game-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            background-color: #3498db;
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #2980b9;
        }

        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        #share-section {
            margin-top: 30px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }

        #share-section h3 {
            margin-top: 0;
            color: #2c3e50;
        }

        #game-url {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        #modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .modal-content h2 {
            margin-top: 0;
            color: #2c3e50;
        }

        .modal-content label {
            display: block;
            margin: 10px 0 5px;
            font-weight: bold;
        }

        .modal-content input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }

        @media (max-width: 600px) {
            #board {
                grid-template-columns: repeat(15, 20px);
                grid-template-rows: repeat(15, 20px);
            }

            .cell {
                width: 20px;
                height: 20px;
            }

            .stone {
                width: 16px;
                height: 16px;
                top: 2px;
                left: 2px;
            }
        }
    </style>
</head>
<body>
    <h1>五子棋联机对战（实时同步版）</h1>

    <div id="modal">
        <div class="modal-content">
            <h2>设置玩家信息</h2>
            <div>
                <label for="player1-name">玩家1名称（黑棋先手）:</label>
                <input type="text" id="player1-name" placeholder="玩家1" maxlength="20">
            </div>
            <div>
                <label for="player2-name">玩家2名称（白棋）:</label>
                <input type="text" id="player2-name" placeholder="玩家2" maxlength="20">
            </div>
            <button id="start-game">开始游戏</button>
        </div>
    </div>

    <div class="container">
        <div id="game-container">
            <div class="player-info">
                <div id="black-player">黑棋: <span id="black-name">未设置</span></div>
                <div id="white-player">白棋: <span id="white-name">未设置</span></div>
            </div>
            <div id="status">等待游戏开始...</div>
            <div id="board"></div>
            <div class="game-controls">
                <button id="restart-game" disabled>重新开始</button>
                <button id="copy-url">复制游戏链接</button>
            </div>

            <div id="share-section">
                <h3>游戏共享</h3>
                <p>将下方链接发送给对手，对手打开后即可实时同步游戏：</p>
                <input type="text" id="game-url" readonly>
                <button id="share-btn">分享链接</button>
            </div>
        </div>
    </div>

    <script>
        // 游戏状态
        const gameState = {
            gameId: Math.random().toString(36).substring(2, 10), // 随机游戏ID
            player1: '',
            player2: '',
            board: Array(15).fill().map(() => Array(15).fill(null)),
            currentPlayer: 'black',
            gameActive: false,
            myRole: null // 'player1' 或 'player2'
        };

        // DOM 元素
        const elements = {
            modal: document.getElementById('modal'),
            player1Name: document.getElementById('player1-name'),
            player2Name: document.getElementById('player2-name'),
            startGame: document.getElementById('start-game'),
            status: document.getElementById('status'),
            board: document.getElementById('board'),
            blackName: document.getElementById('black-name'),
            whiteName: document.getElementById('white-name'),
            restartGame: document.getElementById('restart-game'),
            copyUrl: document.getElementById('copy-url'),
            gameUrl: document.getElementById('game-url'),
            shareBtn: document.getElementById('share-btn')
        };

        // 初始化棋盘
        function initBoard() {
            elements.board.innerHTML = '';
            for (let row = 0; row < 15; row++) {
                for (let col = 0; col < 15; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    cell.addEventListener('click', () => handleCellClick(row, col));
                    elements.board.appendChild(cell);
                }
            }
        }

        // 处理格子点击
        function handleCellClick(row, col) {
            if (!gameState.gameActive ||
                gameState.board[row][col] ||
                (gameState.currentPlayer === 'black' && gameState.myRole !== 'player1') ||
                (gameState.currentPlayer === 'white' && gameState.myRole !== 'player2')) {
                return;
            }

            placeStone(row, col, gameState.currentPlayer);
            checkWin(row, col, gameState.currentPlayer);
            saveGameState();
        }

        // 放置棋子
        function placeStone(row, col, color) {
            gameState.board[row][col] = color;
            gameState.currentPlayer = color === 'black' ? 'white' : 'black';

            const cell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
            const stone = document.createElement('div');
            stone.className = `stone ${color}`;
            cell.appendChild(stone);

            updateStatus();
        }

        // 检查胜利条件
        function checkWin(row, col, color) {
            const directions = [
                [0, 1], [1, 0], [1, 1], [1, -1]
            ];

            for (const [dx, dy] of directions) {
                let count = 1;
                for (let i = 1; i < 5; i++) {
                    const newRow = row + i * dx;
                    const newCol = col + i * dy;
                    if (newRow < 0 || newRow >= 15 || newCol < 0 || newCol >= 15 || gameState.board[newRow][newCol] !== color) break;
                    count++;
                }
                for (let i = 1; i < 5; i++) {
                    const newRow = row - i * dx;
                    const newCol = col - i * dy;
                    if (newRow < 0 || newRow >= 15 || newCol < 0 || newCol >= 15 || gameState.board[newRow][newCol] !== color) break;
                    count++;
                }

                if (count >= 5) {
                    endGame(`${color === 'black' ? gameState.player1 : gameState.player2} 赢了!`);
                    return;
                }
            }

            if (gameState.board.flat().every(cell => cell !== null)) {
                endGame('平局!');
            }
        }

        // 保存游戏状态到localStorage
        function saveGameState() {
            const state = {
                gameId: gameState.gameId,
                player1: gameState.player1,
                player2: gameState.player2,
                board: gameState.board,
                currentPlayer: gameState.currentPlayer,
                gameActive: gameState.gameActive
            };
            localStorage.setItem('gomoku_game_state', JSON.stringify(state));
            updateURL();
        }

        // 从localStorage加载游戏状态
        function loadGameState() {
            const saved = localStorage.getItem('gomoku_game_state');
            if (!saved) return false;

            const state = JSON.parse(saved);
            if (state.gameId !== gameState.gameId) return false;

            // 恢复游戏状态
            gameState.player1 = state.player1;
            gameState.player2 = state.player2;
            gameState.board = state.board;
            gameState.currentPlayer = state.currentPlayer;
            gameState.gameActive = state.gameActive;

            // 更新UI
            elements.blackName.textContent = gameState.player1;
            elements.whiteName.textContent = gameState.player2;
            renderBoard();
            updateStatus();
            elements.restartGame.disabled = gameState.gameActive;

            return true;
        }

        // 渲染棋盘状态
        function renderBoard() {
            // 清空棋盘
            document.querySelectorAll('.stone').forEach(stone => stone.remove());

            // 重新渲染所有棋子
            for (let row = 0; row < 15; row++) {
                for (let col = 0; col < 15; col++) {
                    if (gameState.board[row][col]) {
                        const cell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
                        const stone = document.createElement('div');
                        stone.className = `stone ${gameState.board[row][col]}`;
                        cell.appendChild(stone);
                    }
                }
            }
        }

        // 更新URL参数
        function updateURL() {
            const newUrl = `${window.location.origin}${window.location.pathname}?game=${gameState.gameId}&role=${gameState.myRole}`;
            elements.gameUrl.value = newUrl;
            window.history.pushState({}, '', newUrl);
        }

        // 监听storage事件（实现实时同步）
        window.addEventListener('storage', (event) => {
            if (event.key === 'gomoku_game_state') {
                // 检查是否是当前游戏的更新
                try {
                    const newState = JSON.parse(event.newValue);
                    if (newState.gameId === gameState.gameId) {
                        // 只更新来自对手的移动（防止自己触发的事件循环）
                        if (newState.currentPlayer !== gameState.currentPlayer ||
                            JSON.stringify(newState.board) !== JSON.stringify(gameState.board)) {
                            gameState.board = newState.board;
                            gameState.currentPlayer = newState.currentPlayer;
                            gameState.gameActive = newState.gameActive;
                            renderBoard();
                            updateStatus();
                        }
                    }
                } catch (e) {
                    console.error('解析游戏状态失败:', e);
                }
            }
        });

        // 初始化游戏
        function initGame() {
            const params = new URLSearchParams(window.location.search);
            const gameId = params.get('game');
            const role = params.get('role');

            if (gameId && role) {
                // 加入已有游戏
                gameState.gameId = gameId;
                gameState.myRole = role;

                // 尝试加载游戏状态
                if (loadGameState()) {
                    elements.modal.style.display = 'none';
                } else {
                    alert('游戏不存在或已过期，请创建新游戏');
                    elements.modal.style.display = 'flex';
                }
            } else {
                // 创建新游戏
                elements.modal.style.display = 'flex';
            }
        }

        // 事件监听器
        elements.startGame.addEventListener('click', () => {
            const player1 = elements.player1Name.value.trim();
            const player2 = elements.player2Name.value.trim();

            if (player1.length < 1 || player2.length < 1) {
                alert('请输入玩家名称');
                return;
            }

            gameState.player1 = player1;
            gameState.player2 = player2;
            gameState.myRole = 'player1'; // 创建游戏的人是玩家1
            elements.blackName.textContent = player1;
            elements.whiteName.textContent = player2;

            elements.modal.style.display = 'none';
            resetGame();
        });

        elements.restartGame.addEventListener('click', () => {
            resetGame();
        });

        elements.copyUrl.addEventListener('click', () => {
            elements.gameUrl.select();
            document.execCommand('copy');
            alert('链接已复制到剪贴板');
        });

        elements.shareBtn.addEventListener('click', () => {
            if (navigator.share) {
                navigator.share({
                    title: '五子棋对战邀请',
                    text: `快来和我下五子棋吧！我是${gameState.myRole === 'player1' ? gameState.player1 : gameState.player2}`,
                    url: elements.gameUrl.value
                }).catch(err => {
                    console.log('分享失败:', err);
                });
            } else {
                alert('链接已准备好，请手动发送给对手');
            }
        });

        function resetGame() {
            gameState.board = Array(15).fill().map(() => Array(15).fill(null));
            gameState.currentPlayer = 'black';
            gameState.gameActive = true;
            renderBoard();
            updateStatus();
            elements.restartGame.disabled = true;
            saveGameState();
        }

        function endGame(message) {
            gameState.gameActive = false;
            elements.status.textContent = message;
            elements.restartGame.disabled = false;
            saveGameState();
        }

        function updateStatus() {
            if (!gameState.gameActive) return;
            const currentPlayerName = gameState.currentPlayer === 'black' ? gameState.player1 : gameState.player2;
            elements.status.textContent = `轮到 ${currentPlayerName} (${gameState.currentPlayer === 'black' ? '黑棋' : '白棋'})`;
        }

        // 初始化
        initBoard();
        initGame();
    </script>
</body>
</html>