<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多人联机五子棋</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            min-height: 100vh;
            color: #333;
        }
        .container {
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            padding: 20px;
            margin-top: 20px;
        }
        header {
            text-align: center;
            margin-bottom: 20px;
            width: 100%;
        }
        h1 {
            color: #2c3e50;
            font-size: 2.8rem;
            margin: 15px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            background: linear-gradient(to right, #3498db, #2c3e50);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .game-info {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .info-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex: 1;
            margin: 0 10px;
            text-align: center;
        }
        .info-card h3 {
            color: #3498db;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        #status {
            font-size: 1.4rem;
            font-weight: bold;
            color: #e74c3c;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #players {
            font-size: 1.1rem;
            color: #2c3e50;
            line-height: 1.6;
        }
        .game-id-display {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #2c3e50;
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 1.2rem;
            margin-top: 10px;
        }
        #copy-btn {
            background: #3498db;
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            margin-left: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        #copy-btn:hover {
            background: #2980b9;
            transform: scale(1.1);
        }
        .game-content {
            display: flex;
            width: 100%;
            gap: 20px;
            margin-bottom: 20px;
        }
        .game-board {
            flex: 1;
            background-color: #e0b45c;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            position: relative;
        }
        #board {
            display: grid;
            grid-template-columns: repeat(15, 1fr);
            grid-template-rows: repeat(15, 1fr);
            gap: 1px;
            background-color: #d1a24a;
            border-radius: 5px;
            width: 100%;
            aspect-ratio: 1/1;
            position: relative;
            background-image:
                linear-gradient(rgba(0,0,0,0.3) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.3) 1px, transparent 1px);
            background-size: calc(100% / 15) calc(100% / 15);
        }
        .cell {
            position: relative;
            background-color: rgba(220, 179, 92, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .cell:hover {
            background-color: rgba(232, 200, 120, 0.5);
        }
        .stone {
            width: 85%;
            height: 85%;
            border-radius: 50%;
            position: relative;
            z-index: 1;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .black {
            background: radial-gradient(circle at 30% 30%, #666, #000);
        }
        .white {
            background: radial-gradient(circle at 30% 30%, #fff, #e0e0e0);
            border: 1px solid #ccc;
        }
        .last-move::after {
            content: '';
            position: absolute;
            width: 20%;
            height: 20%;
            background-color: #e74c3c;
            border-radius: 50%;
            z-index: 2;
        }
        .star-point {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: #000;
            border-radius: 50%;
            z-index: 0;
            transform: translate(-50%, -50%);
        }
        .game-controls {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        #restart-game {
            background: linear-gradient(to right, #3498db, #2c3e50);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #restart-game:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        #notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(to right, #3498db, #2c3e50);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            font-weight: bold;
            animation: fadeInOut 3s ease-in-out;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; top: 10px; }
            10%, 90% { opacity: 1; top: 20px; }
        }
        .chat-container {
            flex: 0 0 300px;
            background-color: #f8f9fa;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .chat-header {
            background: linear-gradient(to right, #3498db, #2c3e50);
            color: white;
            padding: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
        }
        #chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .message {
            padding: 12px 15px;
            border-radius: 15px;
            max-width: 80%;
            word-break: break-word;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message.own {
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        .message.other {
            background-color: #e9ecef;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        .message .sender {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        .message .text {
            font-size: 1.05rem;
        }
        .chat-input-container {
            display: flex;
            padding: 15px;
            background-color: white;
            border-top: 1px solid #ddd;
        }
        #chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 30px 0 0 30px;
            font-size: 1rem;
            outline: none;
        }
        #chat-send {
            padding: 12px 20px;
            background: linear-gradient(to right, #3498db, #2c3e50);
            color: white;
            border: none;
            border-radius: 0 30px 30px 0;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        #chat-send:hover {
            background: linear-gradient(to right, #2980b9, #1a252f);
        }
        .win-line {
            position: absolute;
            background-color: rgba(231, 76, 60, 0.7);
            height: 6px;
            z-index: 2;
            transform-origin: 0 0;
        }
        .game-controls-panel {
            width: 100%;
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            width: 100%;
            max-width: 300px;
            text-align: center;
            margin: 10px 0;
            font-size: 1.1rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #create-game {
            background: linear-gradient(to right, #2ecc71, #27ae60);
            color: white;
        }
        #create-game:hover {
            background: linear-gradient(to right, #27ae60, #219653);
            transform: translateY(-3px);
        }
        .input-group {
            width: 100%;
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        #game-id-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 30px;
            font-size: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        #join-game {
            background: linear-gradient(to right, #3498db, #2980b9);
            color: white;
        }
        #join-game:hover {
            background: linear-gradient(to right, #2980b9, #1c6ea4);
            transform: translateY(-3px);
        }
        @media (max-width: 768px) {
            .game-content {
                flex-direction: column;
            }
            .chat-container {
                width: 100%;
                margin-top: 20px;
            }
            .game-board {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="notification"></div>

    <div class="container">
        <header>
            <h1><i class="fas fa-chess-board"></i> 多人联机五子棋</h1>
            <p>与朋友实时对战，体验策略与乐趣！</p>
        </header>

        <div class="game-controls-panel">
            <button id="create-game" class="btn">创建新游戏</button>
            <div class="input-group">
                <input type="text" id="game-id-input" placeholder="输入游戏ID">
                <button id="join-game" class="btn">加入游戏</button>
            </div>
        </div>

        <div class="game-info">
            <div class="info-card">
                <h3><i class="fas fa-info-circle"></i> 游戏状态</h3>
                <div id="status">等待游戏开始...</div>
            </div>
            <div class="info-card">
                <h3><i class="fas fa-users"></i> 玩家信息</h3>
                <div id="players">等待玩家加入...</div>
            </div>
            <div class="info-card">
                <h3><i class="fas fa-gamepad"></i> 游戏控制</h3>
                <button id="restart-game">重新开始</button>
                <div class="game-id-display">
                    <span id="game-id-text"></span>
                    <button id="copy-btn"><i class="fas fa-copy"></i></button>
                </div>
            </div>
        </div>

        <div class="game-content">
            <div class="game-board">
                <div id="board"></div>
            </div>

            <div class="chat-container">
                <div class="chat-header">
                    <i class="fas fa-comments"></i> 游戏聊天室
                </div>
                <div id="chat-messages"></div>
                <div class="chat-input-container">
                    <input type="text" id="chat-input" placeholder="输入消息...">
                    <button id="chat-send">发送</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIZ3e9A4CXltPVT9360Dkf_a0t51M8sWUj0CtnzDf",
            authDomain: "gobang-27d96.firebaseapp.com",
            databaseURL: "https://gobang-27d96-default-rtdb.firebaseio.com",
            projectId: "gobang-27d96",
            storageBucket: "gobang-27d96.firebasestorage.app",
            messagingSenderId: "574024404402",
            appId: "1:574024404402:web:aa74f333a5adc41a289bab",
            measurementId: "G-627M6W1QVN"
        };

        // 初始化Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // 游戏状态
        let gameState = {
            gameId: null,
            playerRole: null, // 'host' 或 'guest'
            currentPlayer: 'black',
            board: Array(15).fill().map(() => Array(15).fill(null)),
            lastMove: null,
            gameOver: false,
            connected: false,
            nickname: '',
            opponentNickname: '',
            isMyTurn: false
        };

        // DOM元素
        const createGameBtn = document.getElementById('create-game');
        const joinGameBtn = document.getElementById('join-game');
        const gameIdInput = document.getElementById('game-id-input');
        const boardElement = document.getElementById('board');
        const statusElement = document.getElementById('status');
        const playersElement = document.getElementById('players');
        const gameIdText = document.getElementById('game-id-text');
        const copyBtn = document.getElementById('copy-btn');
        const restartGameBtn = document.getElementById('restart-game');
        const notificationElement = document.getElementById('notification');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatSend = document.getElementById('chat-send');

        // 初始化棋盘
        function initializeBoard() {
            boardElement.innerHTML = '';

            // 添加星位点
            const starPoints = [
                [3, 3], [3, 11], [11, 3], [11, 11], [7, 7]
            ];

            starPoints.forEach(([row, col]) => {
                const star = document.createElement('div');
                star.className = 'star-point';
                star.style.left = `${(col / 14) * 100}%`;
                star.style.top = `${(row / 14) * 100}%`;
                boardElement.appendChild(star);
            });

            // 添加棋子单元格
            for (let row = 0; row < 15; row++) {
                for (let col = 0; col < 15; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    cell.addEventListener('click', () => handleCellClick(row, col));
                    boardElement.appendChild(cell);
                }
            }
        }

        // 显示通知
        function showNotification(message) {
            notificationElement.textContent = message;
            notificationElement.style.display = 'block';

            setTimeout(() => {
                notificationElement.style.display = 'none';
            }, 3000);
        }

        // 更新UI显示
        function updateUI(board, lastMove) {
            const cells = document.querySelectorAll('.cell');

            // 清除上次移动标记和胜利线
            cells.forEach(cell => {
                cell.classList.remove('last-move');
                const winLine = cell.querySelector('.win-line');
                if (winLine) winLine.remove();
            });

            // 更新棋盘状态
            cells.forEach(cell => {
                const row = parseInt(cell.dataset.row);
                const col = parseInt(cell.dataset.col);
                const stone = board[row][col];

                // 清除原有棋子
                const existingStone = cell.querySelector('.stone');
                if (existingStone) {
                    cell.removeChild(existingStone);
                }

                // 添加新棋子
                if (stone) {
                    const stoneElement = document.createElement('div');
                    stoneElement.className = `stone ${stone}`;
                    cell.appendChild(stoneElement);
                }

                // 标记最后一步
                if (lastMove && lastMove.row === row && lastMove.col === col) {
                    cell.classList.add('last-move');
                }
            });

            // 更新状态信息
            if (gameState.gameOver) {
                statusElement.textContent = `游戏结束 - ${gameState.gameOver === 'draw' ? '平局' : `${gameState.gameOver === 'black' ? '黑方' : '白方'}获胜!`}`;
                statusElement.style.color = '#e74c3c';
            } else {
                gameState.isMyTurn = (gameState.currentPlayer === 'black' && gameState.playerRole === 'host') ||
                                   (gameState.currentPlayer === 'white' && gameState.playerRole === 'guest');

                if (gameState.playerRole === 'host') {
                    statusElement.textContent = `当前回合: ${gameState.currentPlayer === 'black' ? '黑方(你)' : '白方(对手)'}`;
                } else {
                    statusElement.textContent = `当前回合: ${gameState.currentPlayer === 'black' ? '黑方(对手)' : '白方(你)'}`;
                }

                // 如果是我的回合且刚刚切换，显示通知
                if (gameState.isMyTurn && gameState.lastMove && gameState.lastMove.player !== gameState.playerRole) {
                    showNotification('轮到你的回合了！');
                }
            }

            // 更新玩家信息
            updatePlayersInfo();
        }

        // 更新玩家信息显示
        function updatePlayersInfo() {
            let playersText = '';
            if (gameState.playerRole === 'host') {
                playersText = `你: ${gameState.nickname || '房主'}`;
                if (gameState.opponentNickname) {
                    playersText += `<br>对手: ${gameState.opponentNickname}`;
                }
            } else {
                playersText = `对手: ${gameState.opponentNickname || '房主'}`;
                playersText += `<br>你: ${gameState.nickname}`;
            }
            playersElement.innerHTML = playersText;
        }

        // 绘制胜利线
        function drawWinLine(startRow, startCol, endRow, endCol) {
            const startCell = document.querySelector(`.cell[data-row="${startRow}"][data-col="${startCol}"]`);
            const endCell = document.querySelector(`.cell[data-row="${endRow}"][data-col="${endCol}"]`);

            if (!startCell || !endCell) return;

            const boardRect = boardElement.getBoundingClientRect();
            const startRect = startCell.getBoundingClientRect();
            const endRect = endCell.getBoundingClientRect();

            const startX = startRect.left + startRect.width / 2 - boardRect.left;
            const startY = startRect.top + startRect.height / 2 - boardRect.top;
            const endX = endRect.left + endRect.width / 2 - boardRect.left;
            const endY = endRect.top + endRect.height / 2 - boardRect.top;

            const length = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
            const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;

            const line = document.createElement('div');
            line.className = 'win-line';
            line.style.left = `${startX}px`;
            line.style.top = `${startY}px`;
            line.style.width = `${length}px`;
            line.style.transform = `rotate(${angle}deg)`;

            boardElement.appendChild(line);
        }

        // 处理格子点击
        function handleCellClick(row, col) {
            if (gameState.gameOver || !gameState.connected || !gameState.isMyTurn) return;

            if (gameState.board[row][col] !== null) {
                return;
            }

            // 更新本地棋盘
            gameState.board[row][col] = gameState.currentPlayer;
            gameState.lastMove = { row, col, player: gameState.playerRole };

            // 检查胜利条件
            const winResult = checkWin(row, col, gameState.board);

            // 更新Firebase
            const gameRef = database.ref('games/' + gameState.gameId);
            const updateData = {
                board: gameState.board,
                currentPlayer: gameState.currentPlayer === 'black' ? 'white' : 'black',
                lastMove: gameState.lastMove,
                lastUpdated: Date.now()
            };

            if (winResult) {
                updateData.gameOver = winResult.winner;
            }

            gameRef.update(updateData).then(() => {
                gameState.connected = true;

                // 如果是胜利的一步，绘制胜利线
                if (winResult) {
                    gameState.gameOver = winResult.winner;
                    setTimeout(() => {
                        drawWinLine(winResult.start.row, winResult.start.col, winResult.end.row, winResult.end.col);
                    }, 100);
                }
            }).catch((error) => {
                console.error('更新失败:', error);
                gameState.connected = false;
                statusElement.textContent = "连接断开，请刷新页面重试";
                statusElement.style.color = "#e74c3c";
            });
        }

        // 检查胜利条件
        function checkWin(row, col, board) {
            const directions = [
                [ [0, 1], [0, -1] ],   // 水平
                [ [1, 0], [-1, 0] ],   // 垂直
                [ [1, 1], [-1, -1] ],  // 对角线
                [ [1, -1], [-1, 1] ]   // 反对角线
            ];

            const player = board[row][col];

            for (const direction of directions) {
                let count = 1;
                let start = { row, col };
                let end = { row, col };

                for (const [dx, dy] of direction) {
                    let x = row + dx;
                    let y = col + dy;

                    while (x >= 0 && x < 15 && y >= 0 && y < 15 && board[x][y] === player) {
                        count++;
                        if (dx > 0 || dy > 0) {
                            end = { row: x, col: y };
                        } else {
                            start = { row: x, col: y };
                        }
                        x += dx;
                        y += dy;
                    }
                }

                if (count >= 5) {
                    return {
                        winner: player,
                        start,
                        end
                    };
                }
            }

            // 检查平局
            if (board.flat().every(cell => cell !== null)) {
                return { winner: 'draw' };
            }

            return null;
        }

        // 创建新游戏
        function createNewGame() {
            const gameId = generateGameId();
            gameState = {
                gameId,
                playerRole: 'host',
                currentPlayer: 'black',
                board: Array(15).fill().map(() => Array(15).fill(null)),
                lastMove: null,
                gameOver: false,
                connected: true,
                nickname: '房主',
                opponentNickname: ''
            };

            // 显示加载状态
            statusElement.textContent = "创建游戏中...";

            // 初始化Firebase数据
            database.ref('games/' + gameId).set({
                board: gameState.board,
                currentPlayer: 'black',
                lastMove: null,
                gameOver: false,
                created: Date.now(),
                lastUpdated: Date.now(),
                hostNickname: gameState.nickname,
                guestNickname: ''
            }).then(() => {
                // 监听游戏更新
                const gameRef = database.ref('games/' + gameId);
                gameRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        gameState.board = data.board || gameState.board;
                        gameState.currentPlayer = data.currentPlayer || gameState.currentPlayer;
                        gameState.lastMove = data.lastMove || gameState.lastMove;
                        gameState.gameOver = data.gameOver || false;
                        gameState.connected = true;
                        gameState.opponentNickname = data.guestNickname || '';

                        updateUI(gameState.board, gameState.lastMove);
                    }
                });

                // 初始化聊天
                initChat(gameId);

                // 显示游戏ID
                gameIdText.textContent = gameId;

                initializeBoard();
                updateUI(gameState.board);
            }).catch((error) => {
                console.error('创建游戏失败:', error);
                statusElement.textContent = "创建游戏失败，请重试";
                statusElement.style.color = "#e74c3c";
            });
        }

        // 加入游戏
        function joinExistingGame(gameId) {
            // 显示加载状态
            statusElement.textContent = "正在加入游戏...";

            // 检查游戏是否存在
            database.ref('games/' + gameId).once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    // 检查游戏是否已结束
                    if (data.gameOver) {
                        statusElement.textContent = "该游戏已结束";
                        statusElement.style.color = "#e74c3c";
                        return;
                    }

                    gameState = {
                        gameId,
                        playerRole: 'guest',
                        currentPlayer: data.currentPlayer || 'black',
                        board: data.board || Array(15).fill().map(() => Array(15).fill(null)),
                        lastMove: data.lastMove || null,
                        gameOver: data.gameOver || false,
                        connected: true,
                        nickname: '玩家',
                        opponentNickname: data.hostNickname || '房主'
                    };

                    // 更新Firebase中的guestNickname
                    database.ref('games/' + gameId).update({
                        guestNickname: gameState.nickname,
                        lastUpdated: Date.now()
                    });

                    // 监听游戏更新
                    const gameRef = database.ref('games/' + gameId);
                    gameRef.on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            gameState.board = data.board || gameState.board;
                            gameState.currentPlayer = data.currentPlayer || gameState.currentPlayer;
                            gameState.lastMove = data.lastMove || gameState.lastMove;
                            gameState.gameOver = data.gameOver || false;
                            gameState.connected = true;
                            gameState.opponentNickname = data.hostNickname || '房主';

                            updateUI(gameState.board, gameState.lastMove);

                            // 如果游戏结束且有胜利线，绘制它
                            if (gameState.gameOver && gameState.gameOver !== 'draw') {
                                const winResult = checkWinForPlayer(gameState.board, gameState.gameOver);
                                if (winResult) {
                                    drawWinLine(winResult.start.row, winResult.start.col, winResult.end.row, winResult.end.col);
                                }
                            }

                            // 检查连接断开
                            if (data.gameOver === 'disconnected') {
                                statusElement.textContent = "房主已断开连接";
                                statusElement.style.color = "#e74c3c";
                                gameState.connected = false;
                            }
                        }
                    });

                    // 初始化聊天
                    initChat(gameId);

                    initializeBoard();
                    updateUI(gameState.board, gameState.lastMove);
                } else {
                    statusElement.textContent = "未找到该游戏，请检查游戏ID";
                    statusElement.style.color = "#e74c3c";
                }
            }).catch((error) => {
                console.error('加入游戏失败:', error);
                statusElement.textContent = "加入游戏失败，请重试";
                statusElement.style.color = "#e74c3c";
            });
        }

        // 初始化聊天
        function initChat(gameId) {
            const chatRef = database.ref('chats/' + gameId);

            // 加载历史消息
            chatRef.limitToLast(50).once('value').then((snapshot) => {
                const messages = snapshot.val() || {};
                Object.values(messages).forEach(msg => {
                    addMessageToChat(msg);
                });
            });

            // 监听新消息
            chatRef.on('child_added', (snapshot) => {
                const msg = snapshot.val();
                addMessageToChat(msg);
            });

            // 发送消息
            chatSend.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            function sendMessage() {
                const text = chatInput.value.trim();
                if (text && gameState.connected) {
                    const message = {
                        text,
                        sender: gameState.playerRole,
                        nickname: gameState.playerRole === 'host' ? '房主' : '玩家',
                        timestamp: Date.now()
                    };

                    chatRef.push(message).then(() => {
                        chatInput.value = '';
                    }).catch(error => {
                        console.error('发送消息失败:', error);
                    });
                }
            }

            function addMessageToChat(msg) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.sender === gameState.playerRole ? 'own' : 'other'}`;
                messageDiv.innerHTML = `
                    <div class="sender">${msg.nickname}</div>
                    <div class="text">${msg.text}</div>
                `;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        // 检查棋盘上某玩家是否获胜
        function checkWinForPlayer(board, player) {
            for (let row = 0; row < 15; row++) {
                for (let col = 0; col < 15; col++) {
                    if (board[row][col] === player) {
                        const result = checkWin(row, col, board);
                        if (result && result.winner === player) {
                            return result;
                        }
                    }
                }
            }
            return null;
        }

        // 重新开始游戏
        restartGameBtn.addEventListener('click', () => {
            if (!gameState.gameId || gameState.playerRole !== 'host' || !gameState.connected) return;

            gameState.board = Array(15).fill().map(() => Array(15).fill(null));
            gameState.currentPlayer = 'black';
            gameState.lastMove = null;
            gameState.gameOver = false;

            // 清除胜利线
            document.querySelectorAll('.win-line').forEach(el => el.remove());

            database.ref('games/' + gameState.gameId).update({
                board: gameState.board,
                currentPlayer: 'black',
                lastMove: null,
                gameOver: false,
                lastUpdated: Date.now()
            });

            updateUI(gameState.board);
        });

        // 复制游戏ID
        copyBtn.addEventListener('click', () => {
            const gameId = gameIdText.textContent;
            navigator.clipboard.writeText(gameId).then(() => {
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => {
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                }, 2000);
            }).catch((error) => {
                console.error('复制失败:', error);
                copyBtn.innerHTML = '<i class="fas fa-times"></i>';
                setTimeout(() => {
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                }, 2000);
            });
        });

        // 生成随机游戏ID (4位字母+数字)
        function generateGameId() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // 去掉了容易混淆的字符
            let result = '';
            for (let i = 0; i < 4; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // 创建游戏按钮事件
        createGameBtn.addEventListener('click', createNewGame);

        // 加入游戏按钮事件
        joinGameBtn.addEventListener('click', () => {
            const gameId = gameIdInput.value.trim();
            if (!gameId) {
                showNotification('请输入游戏ID');
                return;
            }
            joinExistingGame(gameId);
        });

        // 页面可见性变化时检查通知
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && gameState.isMyTurn) {
                showNotification('轮到你的回合了！');
            }
        });

        // 初始化
        initializeBoard();
    </script>
</body>
</html>
